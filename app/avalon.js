var $jscomp={scope:{},global:this,initSymbolIterator:function(){Symbol=$jscomp.global.Symbol||{};Symbol.iterator||(Symbol.iterator="$jscomp$iterator");$jscomp.initSymbolIterator=function(){}},makeIterator:function(a){$jscomp.initSymbolIterator();if(a[Symbol.iterator])return a[Symbol.iterator]();if(!(a instanceof Array)&&"string"!=typeof a)throw Error();var b=0;return{next:function(){return b==a.length?{done:!0}:{done:!1,value:a[b++]}}}},copyProperties:function(a,b){for(var l in b)a[l]=b[l]},inherits:function(a,
b){function l(){}l.prototype=b.prototype;a.prototype=new l;a.prototype.constructor=a}},Utils=function(){var a=!1,b=[0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935,4657,528,12915,8786,21173,17044,29431,25302,37689,33560,45947,41818,54205,50076,62463,58334,9314,13379,1056,5121,25830,29895,17572,21637,42346,46411,34088,38153,58862,62927,50604,54669,13907,9842,5649,1584,30423,26358,22165,18100,46939,42874,38681,34616,63455,59390,55197,51132,18628,22757,26758,
30887,2112,6241,10242,14371,51660,55789,59790,63919,35144,39273,43274,47403,23285,19156,31415,27286,6769,2640,14899,10770,56317,52188,64447,60318,39801,35672,47931,43802,27814,31879,19684,23749,11298,15363,3168,7233,60846,64911,52716,56781,44330,48395,36200,40265,32407,28342,24277,20212,15891,11826,7761,3696,65439,61374,57309,53244,48923,44858,40793,36728,37256,33193,45514,41451,53516,49453,61774,57711,4224,161,12482,8419,20484,16421,28742,24679,33721,37784,41979,46042,49981,54044,58239,62302,689,
4752,8947,13010,16949,21012,25207,29270,46570,42443,38312,34185,62830,58703,54572,50445,13538,9411,5280,1153,29798,25671,21540,17413,42971,47098,34713,38840,59231,63358,50973,55100,9939,14066,1681,5808,26199,30326,17941,22068,55628,51565,63758,59695,39368,35305,47498,43435,22596,18533,30726,26663,6336,2273,14466,10403,52093,56156,60223,64286,35833,39896,43963,48026,19061,23124,27191,31254,2801,6864,10931,14994,64814,60687,56684,52557,48554,44427,40424,36297,31782,27655,23652,19525,15522,11395,7392,
3265,61215,65342,53085,57212,44955,49082,36825,40952,28183,32310,20053,24180,11923,16050,3793,7920],l=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,
2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],f=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225];this.check_version=function(c){return"3U1504"===c.slice(0,6)||"4M1505"===c.slice(0,6)};this.crc16=function(c){c=new Uint8Array(c);
for(var e=0,h=0,q=c.byteLength;0<q--;)e=b[(e>>>8^c[h++])&255]^e<<8;return e&65535};this.ab2hex=function(c){var e=new Uint8Array(c);c="";for(var e=$jscomp.makeIterator(e),h=e.next();!h.done;h=e.next())c+=("0"+h.value.toString(16)).slice(-2);return c};this.hex2ab=function(c){for(var e=c.length/2,h=new ArrayBuffer(e),q=new Uint8Array(h),d=0;d<e;d++)q[d]=parseInt(c.slice(2*d,2*d+2),16);return h};this.ab2asc=function(c){return String.fromCharCode.apply(null,new Uint8Array(c))};this.str2ab=function(c){for(var e=
c.length,h=new ArrayBuffer(e),q=new Uint8Array(h),d=0;d<e;d++)q[d]=c.charCodeAt(d);return h};this.gwPool2raw=function(c,e,h,q,d){var a=new ArrayBuffer(64),g=new DataView(a),b;e=e.slice(128,152);for(b=0;32>b;b++)g.setUint8(31-b,parseInt(c.slice(2*b,2*b+2),16));g.setUint8(32,h);g.setUint8(33,q);g.setUint32(34,d,!1);for(b=0;12>b;b++)g.setUint8(63-b,parseInt(e.slice(2*b,2*b+2),16));return a};this.sha256=function(c){return(new jsSHA(c,"HEX")).getHash("SHA-256","HEX")};this.getBlockheader=function(c,e){e=
this.uInt2LeHex(e,c.nonce2Size);for(var h=this.sha256(this.sha256(c.coinbase1+c.nonce1+e+c.coinbase2)),a=$jscomp.makeIterator(c.merkleBranch),d=a.next();!d.done;d=a.next())h=this.sha256(this.sha256(h+d.value));a=new ArrayBuffer(76);d=new DataView(a);d.setUint32(0,parseInt(c.version,16));for(var b=0;8>b;b++)d.setUint32(4*(b+1),parseInt(c.prevhash.slice(8*b,8*b+8),16)),d.setUint32(4*(b+9),parseInt(h.slice(8*b,8*b+8),16),!0);d.setUint32(68,parseInt(c.ntime,16));d.setUint32(72,parseInt(c.nbits,16));return this.ab2hex(a)};
this.varifyWork=function(c,e,h,a){e=this.uInt2LeHex(e,c.nonce2Size);e=this.sha256(this.sha256(c.coinbase1+c.nonce1+e+c.coinbase2));for(var d=$jscomp.makeIterator(c.merkleBranch),b=d.next();!b.done;b=d.next())e=this.sha256(this.sha256(e+b.value));d=new ArrayBuffer(80);b=new DataView(d);b.setUint32(0,parseInt(c.version,16),!0);for(var g=0;8>g;g++)b.setUint32(4*(g+1),parseInt(c.prevhash.slice(8*g,8*g+8),16),!0),b.setUint32(4*(g+9),parseInt(e.slice(8*g,8*g+8),16));b.setUint32(68,h,!0);b.setUint32(72,
parseInt(c.nbits,16),!0);b.setUint32(76,a);h=this.sha256(this.sha256(this.ab2hex(d)));if("00000000"!==h.slice(56,64))return 2;c=new Uint8Array(c.target);h=new Uint8Array(this.hex2ab(h));for(a=0;32>a;a++){if(h[31-a]>c[a])return 1;if(h[31-a]<c[a])break}return 0};this.getMidstate=function(c){var e=new DataView(this.hex2ab(c.slice(0,128))),a=[];c=[];var b,d,p,g;for(b=0;16>b;b++)a[b]=e.getUint32(4*b,!0);for(b=0;8>b;b++)c[b]=f[b];b=$jscomp.makeIterator(l);for(e=b.next();!e.done;e=b.next()){var r=e.value,
e=m(c[0],2)^m(c[0],13)^m(c[0],22);d=m(c[4],6)^m(c[4],11)^m(c[4],25);p=c[0]&c[1]^c[0]&c[2]^c[1]&c[2];g=c[4]&c[5]^~c[4]&c[6];c[7]=k(c[7],a[0],r,g,d);c[3]=k(c[3],c[7]);c[7]=k(c[7],p,e);c.unshift(c[7]);c.pop();e=m(a[1],7)^m(a[1],18)^a[1]>>>3;d=m(a[14],17)^m(a[14],19)^a[14]>>>10;a.push(k(a[0],e,a[9],d));a.shift()}a=new ArrayBuffer(32);e=new DataView(a);for(b=0;8>b;b++)e.setUint32(4*b,k(c[b],f[b]),!0);return this.ab2hex(a)};var m=function(c,a){a&=31;return c>>>a|c<<32-a&4294967295},k=function(){for(var c=
0,a=$jscomp.makeIterator(arguments),b=a.next();!b.done;b=a.next())c=c+b.value&4294967295;return c&4294967295};this.padLeft=function(c,a){for(a=2*(a||4);c.length<a;)c="0"+c;return c};this.uInt2LeHex=function(c,a){var b=new ArrayBuffer(4);(new DataView(b)).setUint32(0,c,!0);return this.ab2hex(b).slice(0,2*a)};this.arraySum=function(c){return c.reduce(function(c,a){return c+a})};this.getTarget=function(c){for(var a=new ArrayBuffer(32),b=new DataView(a),f=65535,d=2;16>d;d++)b.setUint16(2*d,Math.floor(f/
c)),f=f%c<<16;return a};this.log=function(c,b,h,f){if(a)switch(f=f||"",h="%c["+h+"] "+b.shift(),b.unshift(f),b.unshift(h),c){case "error":console.error.apply(console,b);break;case "warn":console.warn.apply(console,b);break;case "info":console.info.apply(console,b);break;case "log":console.log.apply(console,b);break;case "debug":console.debug.apply(console,b)}};this.enableLog=function(){a=!0};this.disableLog=function(){a=!1}},utils=new Utils,Pool=function(a,b,l,f,m){var k=1,c=null,e=null,h=0,q=Pool.stratumEncode({id:2,
method:"mining.authorize",params:[f,m||"1234"]}),d="POOL"+a,p,g=this;this.socketId=null;this.id=a;this.alive=!0;this.onJob=new MinerEvent;this.onError=new MinerEvent;var r=function(){chrome.sockets.tcp.create({},function(c){var a=c.socketId,e=!1,h=setTimeout(function(){e=!0;utils.log("warn",["Connection lost (Timed out)"],d,"color: red");g.alive=!1;g.onError.fire(g.id)},5E3);chrome.sockets.tcp.connect(a,b,l,function(c){clearTimeout(h);chrome.runtime.lastError?(e||(utils.log("warn",["Connection lost"],
d,"color: red"),g.alive=!1,g.onError.fire(g.id)),chrome.sockets.tcp.close(a,function(){})):chrome.sockets.tcp.disconnect(a,function(){chrome.sockets.tcp.close(a,function(){clearTimeout(p);p=setTimeout(r,5E3)})})})})},n=function(c,a){utils.log("log",["Sent:     %s",utils.ab2asc(c)],d,"color: darksalmon");chrome.sockets.tcp.send(g.socketId,c,function(b){chrome.runtime.lastError&&(utils.log("error",[chrome.runtime.lastError.message],d),a&&n(c,a-1))})};this.receive=function(a){clearTimeout(p);p=setTimeout(r,
1E3);utils.log("log",["Received: %s",utils.ab2asc(a)],d,"color: goldenrod");a=$jscomp.makeIterator(Pool.stratumDecode(a));for(var b=a.next();!b.done;b=a.next())a:switch(b=b.value,b.method){case "mining.set_difficulty":k=b.params[b.params.length-1];break;case "mining.notify":b={poolId:g.id,nonce1:c,nonce2Size:e,jobId:b.params[0],prevhash:b.params[1],coinbase1:b.params[2],coinbase2:b.params[3],merkleBranch:b.params[4],version:b.params[5],nbits:b.params[6],ntime:b.params[7],cleanJobs:b.params[8],target:utils.getTarget(k)};
g.onJob.fire(b);break;case "mining.ping":n(Pool.stratumEncode({id:b.id,result:"pong",error:null}));break;case "client.reconnect":g.disconnect();g.connect();break;default:if(1===b.id){if(b.error)break a;c=b.result[b.result.length-2];e=b.result[b.result.length-1];"mining.set_difficulty"===b.result[0][0][0]&&(k=b.result[0][0][1]);n(q)}}};this.connect=function(){chrome.sockets.tcp.create({},function(c){g.socketId=c.socketId;var a=!1,e=setTimeout(function(){a=!0;utils.log("warn",["Connection failed (Timed out)"],
d,"color: red");g.alive=!1;g.onError.fire(g.id)},5E3);chrome.sockets.tcp.connect(g.socketId,b,l,function(b){clearTimeout(e);chrome.runtime.lastError?(a||(utils.log("warn",["Connection failed"],d,"color: red"),g.alive=!1,g.onError.fire(g.id)),chrome.sockets.tcp.close(g.socketId,function(){})):(utils.log("info",["Connected"],d,"color: maroon"),g.alive=!0,n(Pool.SUBSCRIBE),p=setTimeout(r,5E3))})})};this.disconnect=function(){clearTimeout(p);null!==this.socketId&&chrome.sockets.tcp.disconnect(this.socketId,
function(){chrome.sockets.tcp.close(g.socketId,function(){utils.log("info",["Disconnected"],d,"color: maroon")})})};this.submit=function(b,c,a,e){utils.log("info",["Submitted"],d,"color: orangered");b={params:[f,b,c,a,e],id:1E3+h,method:"mining.submit"};h=(h+1)%1E3;n(Pool.stratumEncode(b),3)}};Pool.stratumEncode=function(a){return utils.str2ab(JSON.stringify(a)+"\n")};Pool.stratumDecode=function(a){return utils.ab2asc(a).slice(0,-1).split("\n").map(function(b){return JSON.parse(b)})};
Pool.SUBSCRIBE=Pool.stratumEncode({id:1,method:"mining.subscribe",params:["avalon-miner-chrome"]});
var Avalon=function(a,b,l,f){var m,k;switch(a.productId){case Avalon.NANO_ID:m="Avalon nano";k="NANO"+a.deviceId;break;case Avalon.MINI_ID:m="Avalon4 mini",k="MINI"+a.deviceId}var c,e=1,h=null,q=!1,d=!1;l=l||6500;f=f||[100,100,100];var p=Avalon.pkgEncode(Avalon.P_SET_VOLT,0,1,1,Avalon.voltEncode(l)),g=Avalon.pkgEncode(Avalon.P_SET_FREQ,0,1,1,Avalon.freqEncode([100,100,100])),r=Avalon.pkgEncode(Avalon.P_SET_FREQ,0,1,1,Avalon.freqEncode(f));this.deviceId=a.deviceId;this.deviceType=m;this.dna=null;this.onDetect=
new MinerEvent;this.onNonce=new MinerEvent;this.onStatus=new MinerEvent;var n=this,t=function(b){chrome.hid.send(c,0,b,function(){chrome.runtime.lastError?utils.log("error",[chrome.runtime.lastError.message],k):utils.log("debug",["Sent:     0x%s",utils.ab2hex(b)],k,"color: cadetblue")})},v=function(){chrome.hid.receive(c,function(b,c){if(chrome.runtime.lastError)utils.log("error",[chrome.runtime.lastError.message],k);else{utils.log("debug",["Received: 0x%s",utils.ab2hex(c)],k,"color: mediumpurple");
var a=new DataView(c),d=a.getUint8(0),g=a.getUint8(1);if(d!==Avalon.CANAAN_HEAD1||g!==Avalon.CANAAN_HEAD2)utils.log("warn",["Wrong Package Header."],k);else if(d=a.getUint8(2),g=c.slice(6,38),a.getUint16(38,!1)!==utils.crc16(g))utils.log("warn",["Wrong Package CRC."],k);else switch(a=new DataView(g),d){case Avalon.P_ACKDETECT:d={deviceId:n.deviceId,version:utils.ab2asc(g.slice(8,23)),dna:utils.ab2hex(g.slice(0,8)),asicCount:a.getUint32(23,!1)};n.dna=d.dna;e=d.asicCount;q=!0;n.onDetect.fire(d);utils.log("info",
["Version:  %s",d.version],k,"color: green");utils.log("info",["DNA:      0x%s",d.dna],k,"color: green");break;case Avalon.P_NONCE:for(var f=0;2>f;f++)255!==a.getUint8(16*f+6)&&(d={deviceId:n.deviceId,nonce:a.getUint32(16*f+8)-16384,nonce2:a.getUint32(16*f+2),jqId:a.getUint8(16*f+1),poolId:a.getUint8(16*f+0),ntime:a.getUint8(16*f+7)},n.onNonce.fire(d),utils.log("log",["Nonce:    0x%s, roll %s",utils.padLeft((d.nonce>>>0).toString(16)),d.ntime],k,"color: blue"));break;case Avalon.P_STATUS:d="Avalon nano"===
m?{frequency:a.getUint32(0),led:utils.padLeft((a.getUint32(4)>>>0).toString(16)),voltage25:a.getUint32(12),voltageCore:a.getUint32(16),temperature:a.getUint32(20),voltage18:a.getUint16(24),voltage09:a.getUint16(26),power:a.getUint32(28)}:{spiSpeed:a.getUint32(0),led:utils.padLeft((a.getUint32(4)>>>0).toString(16)),voltage:Avalon.voltDecode(a.getUint32(12)),voltageSource:Avalon.voltSourceDecode(a.getUint32(16)),temperatureCu:Avalon.temperatureDecode(a.getUint32(20)),temperatureFan:Avalon.temperatureDecode(a.getUint32(24)),
power:a.getUint32(28)};"poll"===h&&(h=1===d.power?"push":"init");for(f in d)d[f]===n[f]&&delete d[f];if(0<Object.keys(d).length){args=["Status:   "];for(f in d)n[f]=d[f],args[0]+=f+" %s, ",args.push(d[f]);utils.log("log",args,k,"color: green");d.deviceId=n.deviceId;n.onStatus.fire(d)}}}})},y=function(){(function u(){if(d)switch(h){case "poll":t(Avalon.POLL_PKG);v();setTimeout(u,1);break;case "push":w();break;case "init":x()}})()},w=function(){(function u(){if(d){var a=b.shift();void 0!==a?(t(a[0]),
t(Avalon.roll(a[1],e-1)),h="poll",setTimeout(y,"Avalon nano"===m?900:Math.round(17575/f[0]))):setTimeout(u,10)}})()},x=function(){d&&(t(p),setTimeout(function(){d&&(t(g),t(r),h="push",w())},1E3))};this.setVoltage=function(a){"Avalon nano"!==this.deviceType&&a!==l&&(l=a,p=Avalon.pkgEncode(Avalon.P_SET_VOLT,0,1,1,Avalon.voltEncode(a)),null!==h&&t(p))};this.setFrequency=function(a){"Avalon nano"===this.deviceType||a[0]===f[0]&&a[1]===f[1]&&a[2]===f[2]||(f=a,r=Avalon.pkgEncode(Avalon.P_SET_FREQ,0,1,1,
Avalon.freqEncode(a)),null!==h&&t(r))};this.run=function(){if(!q||d)return!1;d=!0;h="init";x()};this.connect=function(){chrome.hid.connect(n.deviceId,function(a){chrome.runtime.lastError?utils.log("error",[chrome.runtime.lastError.message],k):(c=a.connectionId,t(Avalon.DETECT_PKG),v())})};this.disconnect=function(){chrome.hid.disconnect(c,function(){})};this.stop=function(){d=!1;h=null}};Avalon.VENDOR_ID=10737;Avalon.NANO_ID=13299;Avalon.MINI_ID=16625;
Avalon.FILTERS={filters:[{vendorId:Avalon.VENDOR_ID,productId:Avalon.NANO_ID},{vendorId:Avalon.VENDOR_ID,productId:Avalon.MINI_ID}]};Avalon.P_DETECT=16;Avalon.P_SET_VOLT=34;Avalon.P_SET_FREQ=35;Avalon.P_WORK=36;Avalon.P_POLL=48;Avalon.P_REQUIRE=49;Avalon.P_TEST=50;Avalon.P_ACKDETECT=64;Avalon.P_STATUS=65;Avalon.P_NONCE=66;Avalon.P_TEST_RET=67;Avalon.CANAAN_HEAD1=67;Avalon.CANAAN_HEAD2=78;Avalon.FREQ_TABLE=[];Avalon.FREQ_TABLE[150]=575177799;Avalon.FREQ_TABLE[163]=845972551;
Avalon.FREQ_TABLE[175]=438731847;Avalon.FREQ_TABLE[188]=472319047;Avalon.FREQ_TABLE[200]=505906247;Avalon.FREQ_TABLE[213]=539493447;Avalon.FREQ_TABLE[225]=573080647;Avalon.FREQ_TABLE[238]=606667847;Avalon.FREQ_TABLE[250]=640255047;Avalon.FREQ_TABLE[263]=673842247;Avalon.FREQ_TABLE[275]=707429447;Avalon.FREQ_TABLE[288]=741016647;Avalon.FREQ_TABLE[300]=774603847;Avalon.FREQ_TABLE[313]=808191047;Avalon.FREQ_TABLE[325]=841778247;Avalon.FREQ_TABLE[338]=875365447;Avalon.FREQ_TABLE[350]=436634695;
Avalon.FREQ_TABLE[363]=942539847;Avalon.FREQ_TABLE[375]=470221895;Avalon.FREQ_TABLE[388]=1009714247;Avalon.FREQ_TABLE[400]=503809095;Avalon.pkgEncode=function(a,b,l,f,m){var k=new ArrayBuffer(40),c=new Uint8Array(k),e=new DataView(k);c[0]=Avalon.CANAAN_HEAD1;c[1]=Avalon.CANAAN_HEAD2;c[2]=a;c[3]=b;c[4]=l;c[5]=f;c.set(new Uint8Array(m),6);a=utils.crc16(k.slice(6,38));e.setUint16(38,a,!1);return k};
Avalon.roll=function(a,b){var l=new DataView(a);l.setUint8(14,b);l.setUint16(38,utils.crc16(a.slice(6,38)),!1);return a};Avalon.voltEncode=function(a){if(0===a)return utils.hex2ab("00ff");var b=new ArrayBuffer(2);(new DataView(b)).setUint16(0,(89-(a-5E3)/125&255)<<1|1,!1);return b};Avalon.voltDecode=function(a){return 255===a?0:125*(89-(a>>>1))+5E3};
Avalon.freqEncode=function(a){for(var b=new ArrayBuffer(12),l=new DataView(b),f=0;3>f;f++)l.setUint32(4*f,Avalon.FREQ_TABLE[Math.round(12.5*Math.floor(a[f]/12.5))]);return b};Avalon.voltSourceDecode=function(a){return(3.3*a/1023*11).toFixed(1)};Avalon.temperatureDecode=function(a){return(1/(1/298.15-Math.log(1023/a-1)/3450)-273.15).toFixed(1)};Avalon.DETECT_PKG=Avalon.pkgEncode(Avalon.P_DETECT,0,1,1,0);Avalon.POLL_PKG=Avalon.pkgEncode(Avalon.P_POLL,0,1,1,0);
var MinerEvent=function(){var a=[];this.addListener=function(b){return a.push(b)-1};this.removeListener=function(b){delete a[b]};this.fire=function(b){for(var l=$jscomp.makeIterator(a),f=l.next();!f.done;f=l.next())f=f.value,void 0!==f&&f(b)}};
